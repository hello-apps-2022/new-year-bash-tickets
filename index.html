<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Year Bash @ Lalit Mahal - Ticketing</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Removed old .required-label::after CSS */
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white shadow-xl rounded-2xl p-6 md:p-8 border border-gray-100">

        <!-- Header and Event Details -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-800 mb-1">New Year Bash</h1>
            <h2 class="text-xl font-semibold text-gray-700">@ Lalit Mahal, Mysore</h2>
            <p class="text-sm text-gray-500 mt-2">Dec 31st, 7 PM onwards</p>
        </header>

        <form id="ticketForm" class="space-y-6">

            <!-- Customer Details -->
            <div class="space-y-4 border-b pb-4">
                <h3 class="text-lg font-bold text-gray-800">1. Your Details</h3>
                <div>
                    <!-- Added manual red asterisk -->
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name<span class="text-red-500">*</span></label>
                    <input type="text" id="name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div>
                    <!-- Added manual red asterisk and error element -->
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number (10 digits)<span class="text-red-500">*</span></label>
                    <input type="tel" id="phone" name="phone" required 
                           pattern="[0-9]{10}" 
                           title="Phone number must be exactly 10 digits (0-9)."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <p id="phoneError" class="text-xs text-red-500 mt-1 hidden">Please enter exactly 10 digits for the phone number.</p>
                </div>
                <div>
                    <!-- Added manual red asterisk and error element -->
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address<span class="text-red-500">*</span></label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <p id="emailError" class="text-xs text-red-500 mt-1 hidden">Please enter a valid email address (e.g., user@domain.com).</p>
                </div>
            </div>

            <!-- Ticket Selection -->
            <div class="space-y-4 border-b pb-4">
                <!-- Added manual red asterisk and error element -->
                <h3 class="text-lg font-bold text-gray-800">2. Select Tickets<span class="text-red-500">*</span></h3>
                <p id="ticketError" class="text-xs text-red-500 hidden">Please select at least one ticket.</p>

                <div class="space-y-3">
                    <!-- Stag Ticket -->
                    <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-xl">
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-900">Stag Entry (₹3999)</span>
                            <span class="text-xs text-gray-500">For individual males.</span>
                        </div>
                        <input type="number" id="stag_count" name="stag_count" value="0" min="0" max="10" data-price="3999" class="ticket-count w-16 text-center border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Ladies Ticket -->
                    <div class="flex justify-between items-center p-3 bg-pink-50 rounded-xl">
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-900">Ladies Entry (₹2499)</span>
                            <span class="text-xs text-gray-500">For individual females.</span>
                        </div>
                        <input type="number" id="lady_count" name="lady_count" value="0" min="0" max="10" data-price="2499" class="ticket-count w-16 text-center border-gray-300 rounded-lg shadow-sm focus:ring-pink-500 focus:border-pink-500">
                    </div>

                    <!-- Couple Ticket -->
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-xl">
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-900">Couple Entry (₹5999)</span>
                            <span class="text-xs text-gray-500">For one male and one female.</span>
                        </div>
                        <input type="number" id="couple_count" name="couple_count" value="0" min="0" max="10" data-price="5999" class="ticket-count w-16 text-center border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <!-- Total Amount Display -->
                <div class="mt-4 pt-3 border-t-2 border-dashed border-gray-200">
                    <p class="text-xl font-bold flex justify-between items-center text-gray-800">
                        Total Amount:
                        <span id="total_amount_display" class="text-indigo-600">₹0</span>
                    </p>
                    <input type="hidden" id="total_amount" name="total_amount" value="0">
                    <input type="hidden" id="total_tickets" name="total_tickets" value="0">
                </div>
            </div>

            <!-- Payment Instructions -->
            <div class="space-y-4 border-b pb-4">
                <h3 class="text-lg font-bold text-gray-800">3. Manual UPI Payment</h3>
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                    <p class="font-bold text-yellow-800 mb-2">Payment Instructions (No Automated Gateway)</p>
                    <p class="text-sm text-gray-700">Please transfer the **Total Amount** shown above manually using any UPI app (like GPay, PhonePe, or Paytm) to the UPI ID below:</p>
                    <div class="mt-2 p-2 bg-yellow-100 rounded-lg border border-yellow-300 text-center">
                        <span class="text-lg font-mono text-yellow-900 font-bold">9663798289@ybl</span>
                    </div>
                </div>

                <!-- Payment Screenshot Upload (Now Mandatory) -->
                <div>
                    <!-- Added manual red asterisk and error element -->
                    <label for="payment_proof" class="block text-sm font-medium text-gray-700 mb-1">Payment Proof (Required for verification)<span class="text-red-500">*</span></label>
                    <input type="file" id="payment_proof" name="payment_proof_file" accept="image/*" required class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100
                    ">
                    <p id="fileError" class="text-xs text-red-500 mt-1 hidden">Payment proof file is required.</p>
                </div>
            </div>

            <!-- Submission and Status -->
            <div class="pt-4">
                <button type="submit" id="submitButton" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300 disabled:opacity-50" disabled>
                    Submit Booking & Await Verification
                </button>
                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center hidden" role="alert"></div>
            </div>

        </form>

    </div>

    <script>
        const UPI_ID = '9663798289@ybl';
        // IMPORTANT: Ensure this URL is replaced with your deployed Google Apps Script URL ending in /exec
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbybWFfG7aTWAHpMsZiVv8lvbVVjih6pWAFzNlRfumzX9C_-EMHIHr64oXtLeVqndQxrkQ/exec'; 
        const ticketPrices = {
            stag: 3999,
            lady: 2499,
            couple: 5999
        };

        const ticketCounts = document.querySelectorAll('.ticket-count');
        const totalAmountDisplay = document.getElementById('total_amount_display');
        const totalAmountInput = document.getElementById('total_amount');
        const totalTicketsInput = document.getElementById('total_tickets');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const form = document.getElementById('ticketForm');
        
        // Regex for strict 10-digit validation
        const phoneRegex = /^[0-9]{10}$/;
        // New Regex for robust email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        // Error message elements
        const phoneError = document.getElementById('phoneError');
        const emailError = document.getElementById('emailError');
        const ticketError = document.getElementById('ticketError');
        const fileError = document.getElementById('fileError');
        
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const nameInput = document.getElementById('name');
        const fileInput = document.getElementById('payment_proof'); 

        // --- Validation Functions for User Feedback ---

        function validatePhone() {
            const isValid = phoneRegex.test(phoneInput.value);
            // Show error if the field has content BUT is not 10 digits
            // We check length > 0 so that the error doesn't appear when the form is initially loaded (empty)
            if (phoneInput.value.length > 0 && !isValid) {
                phoneError.classList.remove('hidden');
                phoneInput.classList.add('border-red-500');
            } else {
                // Hide error if empty OR valid
                phoneError.classList.add('hidden');
                phoneInput.classList.remove('border-red-500');
            }
            return isValid;
        }

        function validateEmail() {
            // Use the new Regex for immediate feedback on input
            const isValid = emailRegex.test(emailInput.value);

            // Show error if the field has content BUT is not a valid email format
            if (emailInput.value.length > 0 && !isValid) {
                emailError.classList.remove('hidden');
                emailInput.classList.add('border-red-500');
            } else {
                // Hide error if empty OR valid
                emailError.classList.add('hidden');
                emailInput.classList.remove('border-red-500');
            }
            return isValid;
        }

        // --- Core Calculation & Button Enablement Logic ---
        function calculateTotal() {
            let total = 0;
            let totalTickets = 0;

            ticketCounts.forEach(input => {
                const count = parseInt(input.value) || 0;
                const price = parseInt(input.getAttribute('data-price'));
                total += count * price;
                totalTickets += count;
            });

            const isTicketValid = totalTickets > 0;
            if (!isTicketValid) {
                ticketError.classList.remove('hidden');
            } else {
                ticketError.classList.add('hidden');
            }

            const isFileValid = fileInput.files.length > 0;
            if (!isFileValid) {
                fileError.classList.remove('hidden');
            } else {
                fileError.classList.add('hidden');
            }
            
            // Re-run field validations to update the UI (errors)
            // NOTE: These function calls also handle showing/hiding the red error messages
            const isNameFilled = nameInput.value.length > 0;
            const isPhoneValid = validatePhone();
            const isEmailValid = validateEmail();

            // Final check for form submission enablement
            const isFormValid = 
                isNameFilled && 
                isPhoneValid && 
                isEmailValid && 
                isTicketValid && 
                isFileValid; 

            if (isFormValid) {
                 submitButton.removeAttribute('disabled');
            } else {
                 submitButton.setAttribute('disabled', 'true');
            }


            totalAmountDisplay.textContent = `₹${total.toLocaleString('en-IN')}`;
            totalAmountInput.value = total;
            totalTicketsInput.value = totalTickets;
        }

        // Add event listeners for counting, text inputs, and file input
        ticketCounts.forEach(input => {
            input.addEventListener('input', calculateTotal);
        });
        
        // All text fields and file input now trigger the full validation and button check on input
        nameInput.addEventListener('input', calculateTotal);
        phoneInput.addEventListener('input', calculateTotal);
        emailInput.addEventListener('input', calculateTotal);
        fileInput.addEventListener('change', calculateTotal); // Use 'change' for file input
        
        // --- ADDED BLUR LISTENERS FOR BETTER UX FEEDBACK ---
        phoneInput.addEventListener('blur', validatePhone);
        emailInput.addEventListener('blur', validateEmail);


        // Calculate initial total
        calculateTotal();


        // --- Form Submission Logic ---
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Final validation before sending (should mostly pass if button is enabled)
            if (!validatePhone() || !validateEmail() || parseInt(totalTicketsInput.value) === 0 || fileInput.files.length === 0 || nameInput.value.length === 0) {
                 showMessage('Error: Please correct the highlighted errors before submitting.', 'bg-red-100 text-red-700 border-red-300');
                 // Ensure button is disabled if validation fails here
                 submitButton.setAttribute('disabled', 'true');
                 return;
            }

            submitButton.textContent = 'Submitting...';
            submitButton.setAttribute('disabled', 'true');
            showMessage('Submitting your details and proof of payment...', 'bg-indigo-100 text-indigo-700 border-indigo-300');
            
            const formData = new FormData(form);
            const file = fileInput.files[0];

            
            // Read the file asynchronously and convert it to Base64
            const reader = new FileReader();
            
            const fileReadPromise = new Promise((resolve, reject) => {
                reader.onload = (e) => {
                    // Extract base64 part and mimeType
                    const base64Data = e.target.result.split(',')[1];
                    formData.append('fileData', base64Data);
                    formData.append('mimeType', file.type);
                    formData.append('fileName', file.name);
                    resolve();
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });

            try {
                await fileReadPromise;
            } catch (error) {
                console.error('File reading error:', error);
                showMessage('Error reading file. Please try again.', 'bg-red-100 text-red-700 border-red-300');
                submitButton.textContent = 'Submit Booking & Await Verification';
                submitButton.removeAttribute('disabled');
                return;
            }
            
            try {
                // Submit the raw FormData object. 
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData 
                });

                // Assume success if no network error is thrown due to 'no-cors' mode
                showMessage(
                    'Success! Your booking request has been submitted. We have received your payment proof. Your ticket will be emailed once payment is manually verified.',
                    'bg-green-100 text-green-700 border-green-300'
                );
                form.reset();
                calculateTotal(); // Reset calculations
            } catch (error) {
                console.error('Submission Error:', error);
                // Report error, likely related to Apps Script deployment/permissions
                showMessage('An error occurred during submission. **IMPORTANT: If your Google Sheet updated but the file did not upload to Drive, please ensure your Google Apps Script is correctly implemented to handle file creation and that it has the necessary Drive permissions.**', 'bg-red-100 text-red-700 border-red-300');
            } finally {
                submitButton.textContent = 'Submit Booking & Await Verification';
                calculateTotal(); 
            }
        });
        
        function showMessage(message, classes) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 p-3 rounded-lg text-sm border ${classes}`;
            statusMessage.classList.remove('hidden');
        }

    </script>
</body>
</html>
